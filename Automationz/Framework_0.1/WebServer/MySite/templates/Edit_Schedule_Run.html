{% extends 'BaseTemplate.html' %}
{% block title %}Edit Schedule{% endblock %}
{% block content %}
<script type="text/javascript" src="/site_media/Jquery/time_picker/jquery.datetimepicker.js"></script>
<script type="text/javascript" src="/site_media/Jquery/simplepagination/jquery.simplePagination.js"></script>
<link href="/site_media/Jquery/simplepagination/simplePagination.css" rel="stylesheet"/>
<link href="/site_media/Jquery/time_picker/jquery.datetimepicker.css" rel="stylesheet"/>
<table class="two-column-emphasis" width="100%;">
    <caption><b style="font-size: 150%;">Edit Schedule</b></caption>
    <tr>
        <td width="35%;" align="right"><b>Schedule Name:</b></td>
        <td><input class="textbox" value="{{Schedule}}" id="schedule_name"/></td>
    </tr>
    <tr>
        <td width="35%;" align="right"><b>Schedule Name:</b></td>
        <td><input type="hidden" id="test_set_to_run"/></td>
    </tr>
    <tr>
        <td width="35%;" align="right">&nbsp;</td>
        <td id="run_query"><div><img class="delete DeleteTester" title = "TesterDelete" src="/site_media/delete4.png" style="width: 20px; height: 20px"/><b>{{Query}}:</b></div></td>
    </tr>
    <tr>
        <td colspan="2"><div id="RunTestResultTable"></div></td>
    </tr>
    <tr>
        <td colspan="2"><div id="pagination_div"></div></td>
    </tr>
    <tr>
        <td width="35%;" align="right"><b>Dependency: </b></td>
        <td ><div id="parameter_div"></div></td>
    </tr>
    <tr>
        <td><input class="textbox" id="time_picker" placeholder="Select time Here"/></td>
        <script type="text/javascript">
            $('#time_picker').val("{{Time}}");
        </script>
        <td>
            <select id="specific_day"><option value="">Select Day of the Week</option>
                <option value="Sat">Saturday</option>
                <option value="Sun">Sunday</option>
                <option value="Mon">Monday</option>
                <option value="Tue">Tuesday</option>
                <option value="Wed">Wednesday</option>
                <option value="Thu">Thursday</option>
                <option value="Fri">Friday</option>
                <option value="All">Everyday</option>
            </select>
        </td>
        <script type="text/javascript">
            $('#specific_day').val("{{Day}}");
        </script>
    </tr>
    <tr>
        <td><input type="hidden" id="assigned_tester"/></td>
        <td>
            <table>
                <tr id="tester">
                    {% if Testers %}
                        {% for x in Testers%}
                        <td><img class="delete" id = "DeleteTester" title = "TesterDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>
                        <td class="Text" data-id="{{x.0}}">{{x.1}}:&nbsp</td>
                        {% endfor %}
                    {% endif %}
                </tr>
            </table></td>
    </tr>
    <tr>
        <td><input type="hidden" id="email_list"/></td>
        <td>
            <table>
                <tr id="email">
                    {% if Email %}
                        {% for x in Email%}
                            <td><img class="delete" id = "DeleteEmail" title = "EmailDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>
                            <td class="Text" data-id="{{x.0}}">{{x.1}}:&nbsp</td>
                        {% endfor %}
                    {% endif %}
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td><input type="hidden" id="testObjective" /></td>
        <td id="objective"><b>{{TestObjective}}</b></td>
    </tr>
    <tr>
        <td><input type="hidden" id="milestone_list" /></td>
        <td>
            <table>
                <tr id="milestone">
                    {% if Milestone %}
                    <td><img class="delete" id = "DeleteMileStone" title = "MilestoneDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>
                    <td class="Text">{{Milestone}}:&nbsp</td>
                    {% endif %}
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td><input type="hidden" id="machine_list"/></td>
        <td>
            <table>
                <tr id="machine">
                    {% if Machine %}
                    <td><img class="delete" id = "DeleteMachine" title = "MachineDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>
                    <td class="Text">{{Machine}}:&nbsp</td>
                    {% endif %}
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td colspan="2" align="center"><input type="button" id="run_test" class="m-btn green" value="Save Schedule Run"/></td>
    </tr>
</table>

<script type="text/javascript">
    var project_id="{{project_id}}";
    var team_id="{{TeamID}}";
    var user_id= $.session.get('user_id');
    var test_case_per_page=5;
    var dependency_classes=[];
    var test_cases=false;
    var first_dependency_set=true;
    var selected_dependency="{{Dependency}}";
    selected_dependency=selected_dependency.replace(/&#39;/g,'');
    selected_dependency=selected_dependency.substring(1,selected_dependency.length-1).split(", (");
    $(document).ready(function(){
        $("#test_set_to_run").select2({
            placeholder: "One set can be run only. Create Set if not available..",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoSetSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'user_id':user_id,
                        'project_id':project_id,
                        'page':page
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            formatResult: formatUsers
        }).on("change", function(e) {
                    var set_id=$(this).select2('data')['id'];
                    var set_name=$(this).select2('data')['text'].split(' - ')[0].trim();
                    var team_id=$(this).select2('data')['team'];
                    //$('#fill_div').empty();
                    //$('#fill_div').html(fill_div());
                    $('#time_picker').datetimepicker({
                        datepicker:false,
                        format:'H:i',
                        closeOnTimeSelect:true
                    });
                    var message='<div><img class="delete DeleteTester" title = "TesterDelete" src="/site_media/delete4.png" style="width: 20px; height: 20px"/><b>'+set_name+':</b></div>';
                    $('#run_query').html(message);
                    $(this).select2('val','');
                    $('.delete').on('click',function(){
                        $(this).parent().remove();
                    });
                    $('#table_to_show').css({'display':'block'});
                    PerformSearch(1,project_id,team_id);
                    //Submit_button(project_id,team_id);
                    return false;
                });

        function formatUsers(user_details) {
            var markup ='<div><i class="fa fa-folder"></i><span style="font-weight: bold;"><span>' + ' ' + user_details.text + '</span></div>';

            return markup;
        }
        AutoSuggestions(project_id,team_id);
        PerformSearch(1,project_id,team_id);
    });
    function AutoSuggestions(project_id,team_id){
        $("#assigned_tester").select2({
            placeholder: "Assigned Testers...",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoCompleteTesterSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'term': term,
                        'page': page,
                        'project_id': $.session.get('project_id'),
                        'team_id': $.session.get('default_team_identity')
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            formatResult: formatUsers
        }).on("change", function(e) {
                    var user_id=$(this).select2('data')['id'];
                    var user_name=$(this).select2('data')['text'].split(' - ')[0].trim();
                    $("#tester").append('<td><img class="delete" id = "DeleteTester" title = "TesterDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>'
                            + '<td class="Text" data-id="'+user_id+'">'
                            + user_name
                            + ":&nbsp"
                            + '</td>');
                    $(this).select2('val','');
                    return false;
                });

        // Should be used for formatting results, LATER
        function formatUsers(user_details) {
            var markup ='<div><i class="fa fa-user"></i><span style="font-weight: bold;"><span>' + ' ' + user_details.text + '</span></div>';

            return markup;
        }
        $("#DeleteTester").live('click', function() {

            $(this).parent().next().remove();
            //$(this).remove();
            $(this).parent().remove();
        });

        $("#email_list").select2({
            placeholder: "Send Emails...",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoCompleteEmailSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'term': term,
                        'page': page,
                        'project_id': $.session.get('project_id'),
                        'team_id': $.session.get('default_team_identity')
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            formatResult: formatEmails
        }).on("change", function(e) {
                    var user_id=$(this).select2('data')['id'];
                    var user_name=$(this).select2('data')['text'].split(' - ')[0].trim();
                    $("#email").append('<td><img class="delete" id = "DeleteEmail" title = "EmailDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>'
                            + '<td class="Text" data-id="'+user_id+'">'
                            + user_name
                            + ":&nbsp"
                            + '</td>');
                    $(this).select2('val','');
                    return false;
                });
        function formatEmails(user_details) {
            var markup ='<div><i class="fa fa-user"></i><span style="font-weight: bold;"><span>' + ' ' + user_details.text + '</span></div>';

            return markup;
        }
        $("#DeleteEmail").live('click', function() {

            $(this).parent().next().remove();
            //$(this).remove();
            $(this).parent().remove();
        });
        $("#milestone_list").select2({
            placeholder: "Search Milestone...",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoCompleteMilestoneSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'term': term,
                        'page': page,
                        'project_id': $.session.get('project_id'),
                        'team_id': $.session.get('default_team_identity')
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            formatResult: formatMilestone
        }).on("change", function(e) {
                    var milestone_name=$(this).select2('data')['text'].split(' - ')[0].trim();
                    $("#milestone").html('<td><img class="delete" id = "DeleteMileStone" title = "MileStoneDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>'
                            + '<td class="Text">'
                            + milestone_name
                            + ":&nbsp"
                            + '</td>');
                    $(this).select2('val','');
                    return false;
                });
        function formatMilestone(milestone) {
            var markup ='<div><i class="fa fa-file"></i><span style="font-weight: bold;"><span>' + ' ' +milestone.text + '</span></div>';
            return markup;
        }
        $("#DeleteMileStone").live('click', function() {

            $(this).parent().next().remove();
            $(this).parent().remove();
        });
        $("#machine_list").select2({
            placeholder: "Select Machines.. ",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoCompleteUsersSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'term': term,
                        'page': page,
                        'project_id': $.session.get('project_id'),
                        'team_id': $.session.get('default_team_identity')
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            formatResult: formatMachine
        }).on("change", function(e) {
                    var machine_name=$(this).select2('data')['text'].split(' - ')[0].trim();
                    $("#machine").html('<td><img class="delete" id = "DeleteMachine" title = "MachineDelete" src="/site_media/delete4.png" style="width: 30px; height: 30px"/></td>'
                            + '<td class="Text">'
                            + machine_name
                            + ":&nbsp"
                            + '</td>');
                    $(this).select2('val','');
                    $('#run_test').slideDown('slow');
                    return false;
                });
        function formatMachine(machine) {
            var markup ='<div><i class="fa fa-machine"></i><span style="font-weight: bold;"><span>'+ " " +machine.text + '</span></div>';
            return markup;
        }

        $("#DeleteMachine").live('click', function() {

            $(this).parent().next().remove();
            $(this).parent().remove();
            $('#run_test').slideUp("slow");

        });

        $("#testObjective").select2({
            placeholder: "Run Objectives.. ",
            width: 460,
            quietMillis: 250,
            ajax: {
                url: "AutoCompleteObjectiveSearch/",
                dataType: "json",
                queitMillis: 250,
                data: function(term, page) {
                    return {
                        'term': term,
                        'page': page,
                        'project_id': project_id,
                        'team_id': team_id
                    };
                },
                results: function(data, page) {
                    return {
                        results: data.items,
                        more: data.more
                    }
                }
            },
            createSearchChoice: function(term) {
                return {id: term};
            },
            createSearchChoicePosition: "top",
            formatResult: formatObjectives,
            formatSelection: formatObjectives
        }).on("change", function(e) {
                    $('#objective').html('<b>'+$(this).select2('data').id+'</b>');
                    $(this).select2("val",'');
                    return false;
                });
        function formatObjectives(obj_details) {
            //var start = obj_details.text.indexOf(":") + 1;
            //var length = obj_details.text.length;

            //var obj = step_details.text.substr(start, length - 1);
            //var title = step_details.text.substr(0,start-1);

            var markup =
                    '<div>' +
                            '<i class="fa fa-file-text fa-fw"></i> <span style="font-weight: bold;">' + obj_details.id + '</span>' +
                            '</div>';

            return markup;
        }
    }
    function PerformSearch(pageNumber,project_id,team_id,predicate) {
        var UserText='';
        $('#run_query div').each(function(){
            UserText+=$(this).text().trim();
        });
        if(predicate!=undefined){
            UserText=UserText+predicate;
        }
        $.get("TableDataTestCasesOtherPages",{
            Query: UserText,
            test_status_request:true,
            project_id:project_id,
            team_id:team_id,
            total_time:'true',
            test_case_per_page:test_case_per_page,
            test_case_page_current:pageNumber
        },function(data) {
            if (data['TableData'].length == 0)
            {
                $('#RunTestResultTable').html("");
                $('#RunTestResultTable').html("<p class = 'Text'><b>Sorry There is No Test Cases For Selected Query!!!</b></p>");
                $("#RunTestResultTable").fadeIn(1000);
                test_cases=false;
                /*$('#time_panel').html("");
                 $('#time_panel').css({'display':'none'});
                 $('#parameter_div').empty();*/
                $('#pagination_div').pagination('destroy');
            }
            else
            {
                /*$('#time_panel').html('<b class="Text">Time Needed: '+data['time']+'</b> ');
                 $('#time_panel').css({'display':'block'});
                 */
                ResultTable('#RunTestResultTable',data['Heading'],data['TableData'],"Test Cases");
                $('#RunTestResultTable').find('p:eq(0)').html(data['Count']+' Test Cases');
                $('#pagination_div').css({'display':'block'});
                $('#pagination_div').pagination({
                    items:data['Count'],
                    itemsOnPage:test_case_per_page,
                    cssStyle: 'dark-theme',
                    currentPage:pageNumber,
                    displayedPages:2,
                    edges:2,
                    hrefTextPrefix:'#',
                    onPageClick:function(PageNumber){
                        PerformSearch(PageNumber,project_id,team_id);
                    }
                });
                //$("#RunTestResultTable .one-column-emphasis").addClass('two-column-emphasis');
                //$("#RunTestResultTable .one-column-emphasis").removeClass('one-column-emphasis');
                $("#RunTestResultTable").fadeIn(1000);
                test_cases=true;
                implementDropDown("#RunTestResultTable");
                if(predicate==undefined){
                    get_dependency(project_id,team_id,UserText);
                }
            }
        });
    }
    function get_dependency(project_id,team_id,UserText){
        $.get('specific_dependency_settings',{
            Query: UserText,
            project_id:project_id,
            team_id:team_id
        },function(data){
            populate_parameter_div(data,"parameter_div",project_id,team_id);
        });
    }

    function implementDropDown(wheretoplace){
        $(wheretoplace+" tr td:nth-child(2)").css({'color' : 'blue','cursor' : 'pointer'});
        $(wheretoplace+" tr td:nth-child(2)").each(function() {
            var ID=$(this).closest('tr').find('td:nth-child(1)').text().trim();
            var name=$(this).text().trim();
            $(this).html('<div id="'+ID+'name">'+name+'</div><div id="'+ID+'detail" style="display:none;"></div>');
            $.get("TestStepWithTypeInTable",{RunID: ID},function(data) {
                var data_list=data['Result'];
                var column=data['column'];
                ResultTable('#'+ID+'detail',column,data_list,"");
                $('#'+ID+'detail tr').each(function(){
                    $(this).css({'textAlign':'left'});
                });
            });
            $(this).live('click',function(){
                $('#'+ID+'detail').slideToggle("slow");
            });
        });
    }
    function populate_parameter_div(array_list,div_name,project_id,team_id){
        var message="";
        for(var i=0;i<array_list.length;i++){
            var dependency=array_list[i][0];
            message+='<form id="tc_'+dependency+'" class="new_tc_form">';
            message+='<table class="two-column-emphasis">';
            message+='<tr>';
            message+='<td class="tc_form_label_col" width="22%;">'
            message+='<b class="Text">'+dependency+':</b>';
            message+='</td>';
            message+='<td class="tc_form_input_col">';
            //message+='<table width="100%">';
            var equal_size=(100/array_list[i][1].length);
            var dep_name=[];
            //message+='<tr>';
            for(var j=0;j<array_list[i][1].length;j++){
                //message+='<td>';
                message+='<div style="float: left;">';
                message+='<input class="'+dependency.split(' ').join('_')+' cmn-toggle cmn-toggle-yes-no" id="'+dependency.split(' ').join('_')+'_'+array_list[i][1][j]+'" type="radio" name="type" value="'+array_list[i][1][j]+'" style="width:auto;;" />';
                message+='<label for="'+dependency.split(' ').join('_')+'_'+array_list[i][1][j]+'" data-on="'+array_list[i][1][j]+'" data-off="'+array_list[i][1][j]+'" style="margin-right:2%"></label>&nbsp;';
                //message+='</td>';
                message+='</div>';
                dep_name.push(dependency.split(' ').join('_')+'_'+array_list[i][1][j]);
            }
            //message+='</tr>';
            //message+='</table>';
            message+='</td>';
            message+='<tr>';
            message+='</table>';
            message+='</form>';
            var temp={'name':dependency,'list':dep_name};
            dependency_classes.push(temp);
        }
        $('#'+div_name).html(message);
        for(var i=0;i<dependency_classes.length;i++){
            for(var j=0;j<dependency_classes[i].list.length;j++){
                $('#'+dependency_classes[i].list[j]).on('click',function(){
                    PerformSearch(1,project_id,team_id,parseValue(dependency_classes));
                });
            }
        }
        if(first_dependency_set){
            var object_list=[]
            for(var i=0;i<selected_dependency.length;i++){
                if(selected_dependency[i].indexOf("(")!=-1 && selected_dependency.indexOf(")")!=1){
                    var text=selected_dependency[i].substring(selected_dependency[i].indexOf("(")+1,selected_dependency[i].indexOf(")")-1);

                }
                else if(selected_dependency[i].indexOf("(")!=-1){
                    var text=selected_dependency[i].substring(selected_dependency[i].indexOf("(")+1,len(selected_dependency[i].length));
                }
                else if(selected_dependency[i].indexOf(")")!=-1){
                    var text=selected_dependency[i].substring(0,selected_dependency[i].indexOf(")")-1);
                }
                else{
                    continue;
                }
                text=text.split(", [");
                var obj={'main_field':text[0],'vari':text[1]};
                object_list.push(obj);
            }
            for(var i=0;i<object_list.length;i++){
                $('.'+object_list[i].main_field.split(' ').join('_')).attr('checked',false);
                $('.'+object_list[i].main_field.split(' ').join('_')+':radio[value="'+object_list[i].vari+'"]').attr('checked',true);
            }
            first_dependency_set=false;
            PerformSearch(1,project_id,team_id,parseValue(dependency_classes));
        }
    }

    function parseValue(dependency_classes){
        var message="";
        for(var i=0;i<dependency_classes.length;i++){
            $('.'+dependency_classes[i].name.split(' ').join("_")+':checked').each(function(){
                message+=($(this).val().trim()+': ');
            });
        }
        return message;
    }
</script>
{% endblock %}